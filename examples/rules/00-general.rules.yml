# ============================================================================
# REGRAS DE ALERTA GERAIS - CONFIGURA√á√ÉO MODULAR
# ============================================================================
# Este arquivo cont√©m regras de alerting para monitoramento geral de infraestrutura
# Foco em alertas acion√°veis com redu√ß√£o de ru√≠do e separa√ß√£o por severidade
#
# Estrutura:
# - general.critical: Alertas P1 (cr√≠ticos, requerem a√ß√£o imediata)
# - general.warning: Alertas P2 (importantes, requerem aten√ß√£o)
# - general.info: Alertas P3 (informativos, para awareness)
# - monitoring.meta: Monitoramento da pr√≥pria stack
# ============================================================================

groups:
  # ========================================
  # ALERTAS CR√çTICOS (P1)
  # ========================================
  - name: general.critical
    interval: 30s
    rules:
      # Inst√¢ncia completamente down
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: infrastructure
          category: availability
        annotations:
          summary: "üî¥ Inst√¢ncia {{ $labels.instance }} est√° DOWN"
          description: |
            A inst√¢ncia {{ $labels.instance }} do job {{ $labels.job }} est√° inacess√≠vel h√° mais de 1 minuto.
            
            **Detalhes:**
            - Job: {{ $labels.job }}
            - Inst√¢ncia: {{ $labels.instance }}
            - Dura√ß√£o: > 1 minuto
            
            **A√ß√µes imediatas:**
            1. Verificar conectividade de rede
            2. Verificar status do servi√ßo
            3. Verificar logs do sistema
          runbook_url: "https://runbooks.company.com/instance-down"
          dashboard_url: "https://grafana.company.com/d/node-overview"
          alert_id: "INFRA-001"

      # Espa√ßo em disco criticamente baixo
      - alert: DiskSpaceCritical
        expr: |
          (
            node_filesystem_avail_bytes{fstype!~"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs"} / 
            node_filesystem_size_bytes{fstype!~"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs"}
          ) * 100 < 5
        for: 2m
        labels:
          severity: critical
          priority: P1
          team: infrastructure
          category: storage
        annotations:
          summary: "üî¥ Espa√ßo em disco CR√çTICO em {{ $labels.instance }}"
          description: |
            Filesystem {{ $labels.mountpoint }} tem apenas {{ printf "%.1f" $value }}% de espa√ßo livre.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.device }}
            - Ponto de montagem: {{ $labels.mountpoint }}
            - Tipo: {{ $labels.fstype }}
            - Espa√ßo livre: {{ printf "%.1f" $value }}%
            
            **A√ß√µes imediatas:**
            1. Limpar arquivos tempor√°rios
            2. Rotacionar logs antigos
            3. Verificar arquivos grandes desnecess√°rios
            4. Considerar expans√£o do volume
          runbook_url: "https://runbooks.company.com/disk-space-critical"
          alert_id: "INFRA-002"

      # Mem√≥ria criticamente alta
      - alert: MemoryUsageCritical
        expr: |
          (
            1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
          ) * 100 > 95
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: infrastructure
          category: memory
        annotations:
          summary: "üî¥ Uso CR√çTICO de mem√≥ria em {{ $labels.instance }}"
          description: |
            Uso de mem√≥ria est√° em {{ printf "%.1f" $value }}% h√° mais de 5 minutos.
            
            **Detalhes:**
            - Uso atual: {{ printf "%.1f" $value }}%
            - Threshold cr√≠tico: 95%
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes imediatas:**
            1. Identificar processos com alto uso de mem√≥ria
            2. Considerar restart de servi√ßos n√£o cr√≠ticos
            3. Verificar memory leaks
            4. Avaliar necessidade de mais RAM
          runbook_url: "https://runbooks.company.com/memory-critical"
          alert_id: "INFRA-003"

      # Sistema de arquivos somente leitura
      - alert: FilesystemReadOnly
        expr: node_filesystem_readonly{fstype!~"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs"} == 1
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: infrastructure
          category: storage
        annotations:
          summary: "üî¥ Filesystem {{ $labels.mountpoint }} em modo SOMENTE LEITURA"
          description: |
            O filesystem {{ $labels.mountpoint }} est√° em modo somente leitura.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.device }}
            - Ponto de montagem: {{ $labels.mountpoint }}
            - Tipo: {{ $labels.fstype }}
            
            **A√ß√µes imediatas:**
            1. Verificar integridade do filesystem
            2. Executar fsck se necess√°rio
            3. Verificar hardware de storage
            4. Remontar filesystem se poss√≠vel
          runbook_url: "https://runbooks.company.com/filesystem-readonly"
          alert_id: "INFRA-004"

  # ========================================
  # ALERTAS DE WARNING (P2)
  # ========================================
  - name: general.warning
    interval: 60s
    rules:
      # CPU alto sustentado
      - alert: HighCPUUsage
        expr: |
          (
            100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: infrastructure
          category: cpu
        annotations:
          summary: "‚ö†Ô∏è Alto uso de CPU em {{ $labels.instance }}"
          description: |
            CPU usage est√° em {{ printf "%.1f" $value }}% h√° mais de 10 minutos.
            
            **Detalhes:**
            - Uso atual: {{ printf "%.1f" $value }}%
            - Threshold: 80%
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Identificar processos com alto uso de CPU
            2. Verificar se √© comportamento esperado
            3. Considerar otimiza√ß√µes ou scaling
          runbook_url: "https://runbooks.company.com/high-cpu"
          alert_id: "INFRA-005"

      # Espa√ßo em disco baixo (warning)
      - alert: DiskSpaceWarning
        expr: |
          (
            node_filesystem_avail_bytes{fstype!~"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs"} / 
            node_filesystem_size_bytes{fstype!~"tmpfs|overlay|squashfs|proc|sysfs|devtmpfs"}
          ) * 100 < 15
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: infrastructure
          category: storage
        annotations:
          summary: "‚ö†Ô∏è Espa√ßo em disco baixo em {{ $labels.instance }}"
          description: |
            Filesystem {{ $labels.mountpoint }} tem {{ printf "%.1f" $value }}% de espa√ßo livre.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.device }}
            - Espa√ßo livre: {{ printf "%.1f" $value }}%
            - Threshold: 15%
            
            **A√ß√µes recomendadas:**
            1. Planejar limpeza de arquivos
            2. Verificar crescimento de logs
            3. Considerar expans√£o futura
          runbook_url: "https://runbooks.company.com/disk-space-warning"
          alert_id: "INFRA-006"

      # Mem√≥ria alta (warning)
      - alert: HighMemoryUsage
        expr: |
          (
            1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
          ) * 100 > 85
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: infrastructure
          category: memory
        annotations:
          summary: "‚ö†Ô∏è Alto uso de mem√≥ria em {{ $labels.instance }}"
          description: |
            Uso de mem√≥ria est√° em {{ printf "%.1f" $value }}% h√° mais de 10 minutos.
            
            **Detalhes:**
            - Uso atual: {{ printf "%.1f" $value }}%
            - Threshold: 85%
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Monitorar tend√™ncia de crescimento
            2. Identificar processos com alto uso
            3. Considerar otimiza√ß√µes
          runbook_url: "https://runbooks.company.com/high-memory"
          alert_id: "INFRA-007"

      # Load average alto
      - alert: HighLoadAverage
        expr: node_load15 / on(instance) count by(instance) (node_cpu_seconds_total{mode="idle"}) > 2.0
        for: 15m
        labels:
          severity: warning
          priority: P2
          team: infrastructure
          category: performance
        annotations:
          summary: "‚ö†Ô∏è Load average alto em {{ $labels.instance }}"
          description: |
            Load average (15min) est√° em {{ printf "%.2f" $value }} por CPU core.
            
            **Detalhes:**
            - Load per core: {{ printf "%.2f" $value }}
            - Threshold: 2.0 por core
            - Dura√ß√£o: > 15 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar processos em execu√ß√£o
            2. Analisar I/O wait
            3. Considerar balanceamento de carga
          runbook_url: "https://runbooks.company.com/high-load"
          alert_id: "INFRA-008"

      # I/O de disco alto
      - alert: DiskIOHigh
        expr: |
          (
            rate(node_disk_io_time_seconds_total[5m]) * 100
          ) > 80
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: infrastructure
          category: storage
        annotations:
          summary: "‚ö†Ô∏è Alto I/O de disco em {{ $labels.instance }}"
          description: |
            Utiliza√ß√£o de I/O do disco {{ $labels.device }} est√° em {{ printf "%.1f" $value }}%.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.device }}
            - Utiliza√ß√£o I/O: {{ printf "%.1f" $value }}%
            - Threshold: 80%
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Identificar processos com alto I/O
            2. Verificar performance do storage
            3. Considerar otimiza√ß√µes de I/O
          runbook_url: "https://runbooks.company.com/high-disk-io"
          alert_id: "INFRA-009"

      # Erros de rede altos
      - alert: NetworkErrorsHigh
        expr: |
          (
            rate(node_network_receive_errs_total[5m]) + 
            rate(node_network_transmit_errs_total[5m])
          ) > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: network
          category: network
        annotations:
          summary: "‚ö†Ô∏è Erros de rede altos em {{ $labels.instance }}"
          description: |
            Interface {{ $labels.device }} tem {{ printf "%.1f" $value }} erros por segundo.
            
            **Detalhes:**
            - Interface: {{ $labels.device }}
            - Erros/s: {{ printf "%.1f" $value }}
            - Threshold: 10 erros/s
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar cabos e conectores
            2. Analisar logs de rede
            3. Verificar configura√ß√£o da interface
          runbook_url: "https://runbooks.company.com/network-errors"
          alert_id: "NET-001"

  # ========================================
  # ALERTAS INFORMATIVOS (P3)
  # ========================================
  - name: general.info
    interval: 300s  # 5 minutos
    rules:
      # Reinicializa√ß√£o do sistema
      - alert: SystemReboot
        expr: node_boot_time_seconds != on(instance) node_boot_time_seconds offset 1h
        for: 1m
        labels:
          severity: info
          priority: P3
          team: infrastructure
          category: maintenance
        annotations:
          summary: "‚ÑπÔ∏è Sistema {{ $labels.instance }} foi reinicializado"
          description: |
            O sistema {{ $labels.instance }} foi reinicializado recentemente.
            
            **Informa√ß√µes:**
            - Inst√¢ncia: {{ $labels.instance }}
            - Detec√ß√£o: Mudan√ßa no boot time
            
            **Verifica√ß√µes recomendadas:**
            1. Confirmar se foi manuten√ß√£o planejada
            2. Verificar se todos os servi√ßos subiram
            3. Validar funcionamento das aplica√ß√µes
          alert_id: "INFRA-010"

  # ========================================
  # MONITORAMENTO DA STACK (META)
  # ========================================
  - name: monitoring.meta
    interval: 60s
    rules:
      # Prometheus down
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: sre
          category: monitoring
        annotations:
          summary: "üî¥ Prometheus est√° DOWN"
          description: |
            O servidor Prometheus n√£o est√° respondendo h√° mais de 1 minuto.
            
            **Impacto:**
            - Perda de coleta de m√©tricas
            - Alertas podem n√£o funcionar
            - Dashboards indispon√≠veis
            
            **A√ß√µes imediatas:**
            1. Verificar status do container/servi√ßo
            2. Verificar logs do Prometheus
            3. Verificar recursos do sistema
          runbook_url: "https://runbooks.company.com/prometheus-down"
          alert_id: "MON-001"

      # Alertmanager down
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: sre
          category: monitoring
        annotations:
          summary: "üî¥ Alertmanager est√° DOWN"
          description: |
            O Alertmanager n√£o est√° respondendo h√° mais de 1 minuto.
            
            **Impacto:**
            - Alertas n√£o ser√£o enviados
            - Perda de notifica√ß√µes cr√≠ticas
            
            **A√ß√µes imediatas:**
            1. Verificar status do container/servi√ßo
            2. Verificar logs do Alertmanager
            3. Verificar configura√ß√£o
          runbook_url: "https://runbooks.company.com/alertmanager-down"
          alert_id: "MON-002"

      # Falha no reload da configura√ß√£o
      - alert: PrometheusConfigReloadFailed
        expr: prometheus_config_last_reload_successful == 0
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: sre
          category: monitoring
        annotations:
          summary: "‚ö†Ô∏è Falha no reload da configura√ß√£o do Prometheus"
          description: |
            O √∫ltimo reload da configura√ß√£o do Prometheus falhou.
            
            **Detalhes:**
            - Status: Falha no reload
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar sintaxe da configura√ß√£o
            2. Validar arquivos de regras
            3. Verificar logs de erro
          runbook_url: "https://runbooks.company.com/prometheus-config-reload"
          alert_id: "MON-003"

      # Targets n√£o coletados
      - alert: PrometheusTargetsMissing
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: sre
          category: monitoring
        annotations:
          summary: "‚ö†Ô∏è Target {{ $labels.instance }} n√£o est√° sendo coletado"
          description: |
            O target {{ $labels.instance }} do job {{ $labels.job }} n√£o est√° sendo coletado h√° mais de 5 minutos.
            
            **Poss√≠veis causas:**
            - Servi√ßo down na inst√¢ncia
            - Problemas de conectividade
            - Configura√ß√£o incorreta
            - Firewall bloqueando acesso
            
            **A√ß√µes recomendadas:**
            1. Verificar conectividade de rede
            2. Validar configura√ß√£o do target
            3. Verificar status do servi√ßo
          runbook_url: "https://runbooks.company.com/target-missing"
          alert_id: "MON-004"