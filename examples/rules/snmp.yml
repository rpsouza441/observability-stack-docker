# ============================================================================
# REGRAS DE ALERTA SNMP/NETWORK - CONFIGURA√á√ÉO MODULAR
# ============================================================================
# Este arquivo cont√©m regras de alerting espec√≠ficas para monitoramento de
# dispositivos de rede via SNMP (switches, roteadores, firewalls, etc.)
#
# Estrutura:
# - snmp.critical: Alertas P1 (dispositivos down, interfaces cr√≠ticas)
# - snmp.warning: Alertas P2 (performance, utiliza√ß√£o, erros)
# - snmp.info: Alertas P3 (informativos sobre mudan√ßas de estado)
# ============================================================================

groups:
  # ========================================
  # ALERTAS CR√çTICOS SNMP (P1)
  # ========================================
  - name: snmp.critical
    interval: 30s
    rules:
      # Dispositivo SNMP completamente down
      - alert: SNMPDeviceDown
        expr: up{job=~"snmp-.*"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          team: network
          category: availability
        annotations:
          summary: "üî¥ Dispositivo SNMP {{ $labels.instance }} est√° DOWN"
          description: |
            O dispositivo {{ $labels.instance }} n√£o est√° respondendo via SNMP h√° mais de 2 minutos.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Job: {{ $labels.job }}
            - Tipo: {{ $labels.device_type | default "Unknown" }}
            - Localiza√ß√£o: {{ $labels.location | default "Unknown" }}
            - Dura√ß√£o: > 2 minutos
            
            **A√ß√µes imediatas:**
            1. Verificar conectividade de rede: `ping {{ $labels.instance }}`
            2. Verificar se o dispositivo est√° ligado
            3. Verificar configura√ß√£o SNMP no dispositivo
            4. Verificar community string e vers√£o SNMP
            5. Verificar firewall/ACLs
          runbook_url: "https://runbooks.company.com/snmp-device-down"
          alert_id: "SNMP-001"

      # Interface cr√≠tica down (uplinks, trunks)
      - alert: CriticalInterfaceDown
        expr: |
          ifOperStatus{ifAlias=~".*uplink.*|.*trunk.*|.*critical.*|.*core.*",ifAdminStatus="1"} == 2
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: network
          category: connectivity
        annotations:
          summary: "üî¥ Interface CR√çTICA {{ $labels.ifDescr }} DOWN"
          description: |
            A interface cr√≠tica {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} est√° inoperante.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Status Admin: {{ $labels.ifAdminStatus }}
            - Status Operacional: Down
            - Tipo: {{ $labels.ifType }}
            
            **A√ß√µes imediatas:**
            1. Verificar cabo de rede e conectores
            2. Verificar configura√ß√£o da interface
            3. Verificar equipamento conectado
            4. Verificar logs do dispositivo
            5. Considerar failover se dispon√≠vel
          runbook_url: "https://runbooks.company.com/critical-interface-down"
          alert_id: "SNMP-002"

      # Sistema com temperatura cr√≠tica
      - alert: DeviceTemperatureCritical
        expr: |
          entPhySensorValue{entPhySensorType="8"} / entPhySensorScale{entPhySensorType="8"} > 70
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: network
          category: hardware
        annotations:
          summary: "üî¥ Temperatura CR√çTICA no dispositivo {{ $labels.instance }}"
          description: |
            O dispositivo {{ $labels.instance }} est√° com temperatura cr√≠tica de {{ $value }}¬∞C.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Sensor: {{ $labels.entPhysicalDescr }}
            - Temperatura: {{ $value }}¬∞C
            - Threshold cr√≠tico: 70¬∞C
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes imediatas:**
            1. Verificar ventila√ß√£o e ar condicionado
            2. Verificar funcionamento dos fans
            3. Limpar filtros de ar se necess√°rio
            4. Verificar carga de trabalho do dispositivo
            5. Considerar shutdown preventivo se necess√°rio
          runbook_url: "https://runbooks.company.com/device-temperature-critical"
          alert_id: "SNMP-003"

      # Fonte de alimenta√ß√£o com falha
      - alert: PowerSupplyFailure
        expr: |
          entPhySensorValue{entPhySensorType="6",entPhysicalDescr=~".*[Pp]ower.*[Ss]upply.*"} != 1
        for: 1m
        labels:
          severity: critical
          priority: P1
          team: network
          category: hardware
        annotations:
          summary: "üî¥ FALHA na fonte de alimenta√ß√£o do {{ $labels.instance }}"
          description: |
            Detectada falha na fonte de alimenta√ß√£o do dispositivo {{ $labels.instance }}.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Fonte: {{ $labels.entPhysicalDescr }}
            - Status: {{ $value }}
            - Dura√ß√£o: > 1 minuto
            
            **A√ß√µes imediatas:**
            1. Verificar LEDs de status da fonte
            2. Verificar conex√µes de energia
            3. Verificar se h√° fonte redundante
            4. Planejar substitui√ß√£o da fonte
            5. Monitorar estabilidade do dispositivo
          runbook_url: "https://runbooks.company.com/power-supply-failure"
          alert_id: "SNMP-004"

      # CPU cr√≠tica em dispositivo de rede
      - alert: NetworkDeviceCPUCritical
        expr: |
          cpmCPUTotal5minRev{cpmCPUTotalIndex="1"} > 90
        for: 5m
        labels:
          severity: critical
          priority: P1
          team: network
          category: performance
        annotations:
          summary: "üî¥ CPU CR√çTICA no dispositivo {{ $labels.instance }}"
          description: |
            O dispositivo {{ $labels.instance }} est√° com CPU em {{ $value }}% h√° mais de 5 minutos.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - CPU usage: {{ $value }}%
            - Threshold cr√≠tico: 90%
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes imediatas:**
            1. Verificar processos consumindo CPU
            2. Verificar tr√°fego de rede an√¥malo
            3. Verificar ataques DDoS
            4. Considerar redistribui√ß√£o de tr√°fego
            5. Verificar configura√ß√µes de QoS
          runbook_url: "https://runbooks.company.com/network-device-cpu-critical"
          alert_id: "SNMP-005"

  # ========================================
  # ALERTAS DE WARNING SNMP (P2)
  # ========================================
  - name: snmp.warning
    interval: 60s
    rules:
      # Interface com alta utiliza√ß√£o
      - alert: InterfaceHighUtilization
        expr: |
          (
            (
              rate(ifInOctets[5m]) + rate(ifOutOctets[5m])
            ) * 8 / ifSpeed
          ) > 0.8
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: network
          category: performance
        annotations:
          summary: "‚ö†Ô∏è Interface {{ $labels.ifDescr }} com alta utiliza√ß√£o"
          description: |
            A interface {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} est√° com {{ printf "%.1f" ($value * 100) }}% de utiliza√ß√£o.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Utiliza√ß√£o: {{ printf "%.1f" ($value * 100) }}%
            - Velocidade: {{ $labels.ifSpeed | humanize }}bps
            - Threshold: 80%
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Analisar padr√µes de tr√°fego
            2. Verificar se √© pico esperado
            3. Considerar upgrade de link
            4. Implementar QoS se necess√°rio
            5. Balancear tr√°fego se poss√≠vel
          runbook_url: "https://runbooks.company.com/interface-high-utilization"
          alert_id: "SNMP-006"

      # Erros de interface altos
      - alert: InterfaceHighErrors
        expr: |
          (
            rate(ifInErrors[5m]) + rate(ifOutErrors[5m])
          ) > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: network
          category: quality
        annotations:
          summary: "‚ö†Ô∏è Interface {{ $labels.ifDescr }} com muitos erros"
          description: |
            A interface {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} tem {{ printf "%.1f" $value }} erros por segundo.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Erros/s: {{ printf "%.1f" $value }}
            - Threshold: 10 erros/s
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar qualidade do cabo
            2. Verificar conectores e patch panels
            3. Verificar configura√ß√£o de duplex/speed
            4. Analisar logs de erros espec√≠ficos
            5. Considerar substitui√ß√£o de cabo
          runbook_url: "https://runbooks.company.com/interface-high-errors"
          alert_id: "SNMP-007"

      # Descartes de pacotes altos
      - alert: InterfaceHighDiscards
        expr: |
          (
            rate(ifInDiscards[5m]) + rate(ifOutDiscards[5m])
          ) > 50
        for: 5m
        labels:
          severity: warning
          priority: P2
          team: network
          category: performance
        annotations:
          summary: "‚ö†Ô∏è Interface {{ $labels.ifDescr }} descartando pacotes"
          description: |
            A interface {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} est√° descartando {{ printf "%.1f" $value }} pacotes por segundo.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Descartes/s: {{ printf "%.1f" $value }}
            - Threshold: 50 descartes/s
            - Dura√ß√£o: > 5 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar buffers da interface
            2. Verificar congestionamento
            3. Analisar pol√≠ticas de QoS
            4. Verificar capacidade de processamento
            5. Considerar otimiza√ß√µes de tr√°fego
          runbook_url: "https://runbooks.company.com/interface-high-discards"
          alert_id: "SNMP-008"

      # Temperatura alta (warning)
      - alert: DeviceTemperatureWarning
        expr: |
          entPhySensorValue{entPhySensorType="8"} / entPhySensorScale{entPhySensorType="8"} > 60
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: network
          category: hardware
        annotations:
          summary: "‚ö†Ô∏è Temperatura alta no dispositivo {{ $labels.instance }}"
          description: |
            O dispositivo {{ $labels.instance }} est√° com temperatura de {{ $value }}¬∞C.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Sensor: {{ $labels.entPhysicalDescr }}
            - Temperatura: {{ $value }}¬∞C
            - Threshold warning: 60¬∞C
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Monitorar tend√™ncia de temperatura
            2. Verificar ventila√ß√£o do rack
            3. Verificar filtros de ar
            4. Planejar manuten√ß√£o preventiva
          runbook_url: "https://runbooks.company.com/device-temperature-warning"
          alert_id: "SNMP-009"

      # CPU alta em dispositivo de rede
      - alert: NetworkDeviceCPUHigh
        expr: |
          cpmCPUTotal5minRev{cpmCPUTotalIndex="1"} > 80
        for: 15m
        labels:
          severity: warning
          priority: P2
          team: network
          category: performance
        annotations:
          summary: "‚ö†Ô∏è CPU alta no dispositivo {{ $labels.instance }}"
          description: |
            O dispositivo {{ $labels.instance }} est√° com CPU em {{ $value }}% h√° mais de 15 minutos.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - CPU usage: {{ $value }}%
            - Threshold: 80%
            - Dura√ß√£o: > 15 minutos
            
            **A√ß√µes recomendadas:**
            1. Monitorar padr√µes de uso
            2. Verificar picos de tr√°fego
            3. Analisar processos em execu√ß√£o
            4. Considerar otimiza√ß√µes de configura√ß√£o
          runbook_url: "https://runbooks.company.com/network-device-cpu-high"
          alert_id: "SNMP-010"

      # Mem√≥ria alta em dispositivo
      - alert: NetworkDeviceMemoryHigh
        expr: |
          (
            ciscoMemoryPoolUsed / (ciscoMemoryPoolUsed + ciscoMemoryPoolFree) * 100
          ) > 85
        for: 10m
        labels:
          severity: warning
          priority: P2
          team: network
          category: memory
        annotations:
          summary: "‚ö†Ô∏è Mem√≥ria alta no dispositivo {{ $labels.instance }}"
          description: |
            O dispositivo {{ $labels.instance }} est√° com {{ printf "%.1f" $value }}% de uso de mem√≥ria.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Pool: {{ $labels.ciscoMemoryPoolName }}
            - Memory usage: {{ printf "%.1f" $value }}%
            - Threshold: 85%
            - Dura√ß√£o: > 10 minutos
            
            **A√ß√µes recomendadas:**
            1. Verificar tabelas de roteamento grandes
            2. Verificar cache excessivo
            3. Analisar configura√ß√µes de mem√≥ria
            4. Considerar limpeza de cache
          runbook_url: "https://runbooks.company.com/network-device-memory-high"
          alert_id: "SNMP-011"

      # Interface flapping (mudan√ßas frequentes de estado)
      - alert: InterfaceFlapping
        expr: |
          changes(ifOperStatus[10m]) > 4
        for: 1m
        labels:
          severity: warning
          priority: P2
          team: network
          category: stability
        annotations:
          summary: "‚ö†Ô∏è Interface {{ $labels.ifDescr }} com flapping"
          description: |
            A interface {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} mudou de estado {{ $value }} vezes em 10 minutos.
            
            **Detalhes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Mudan√ßas: {{ $value }} em 10 minutos
            - Threshold: > 4 mudan√ßas
            
            **A√ß√µes recomendadas:**
            1. Verificar estabilidade do cabo
            2. Verificar fonte de alimenta√ß√£o
            3. Verificar equipamento conectado
            4. Analisar logs de interface
            5. Verificar configura√ß√£o de STP
          runbook_url: "https://runbooks.company.com/interface-flapping"
          alert_id: "SNMP-012"

  # ========================================
  # ALERTAS INFORMATIVOS SNMP (P3)
  # ========================================
  - name: snmp.info
    interval: 300s  # 5 minutos
    rules:
      # Interface mudou para up
      - alert: InterfaceUp
        expr: |
          ifOperStatus == 1 and ifOperStatus offset 5m == 2
        for: 1m
        labels:
          severity: info
          priority: P3
          team: network
          category: connectivity
        annotations:
          summary: "‚ÑπÔ∏è Interface {{ $labels.ifDescr }} voltou ao ar"
          description: |
            A interface {{ $labels.ifDescr }} no dispositivo {{ $labels.instance }} voltou a funcionar.
            
            **Informa√ß√µes:**
            - Dispositivo: {{ $labels.instance }}
            - Interface: {{ $labels.ifDescr }}
            - Alias: {{ $labels.ifAlias }}
            - Status: Up
            
            **Verifica√ß√µes recomendadas:**
            1. Confirmar funcionamento normal
            2. Verificar tr√°fego na interface
            3. Validar conectividade end-to-end
          alert_id: "SNMP-013"

      # Dispositivo reiniciado
      - alert: DeviceReboot
        expr: |
          sysUpTime / 100 < 300  # Menos de 5 minutos de uptime
        for: 1m
        labels:
          severity: info
          priority: P3
          team: network
          category: maintenance
        annotations:
          summary: "‚ÑπÔ∏è Dispositivo {{ $labels.instance }} foi reiniciado"
          description: |
            O dispositivo {{ $labels.instance }} foi reiniciado recentemente.
            
            **Informa√ß√µes:**
            - Dispositivo: {{ $labels.instance }}
            - Uptime: {{ $value | humanizeDuration }}
            - Detec√ß√£o: sysUpTime < 5 minutos
            
            **Verifica√ß√µes recomendadas:**
            1. Confirmar se foi manuten√ß√£o planejada
            2. Verificar se todas as interfaces subiram
            3. Validar protocolos de roteamento
            4. Verificar logs de boot
          alert_id: "SNMP-014"

# ============================================================================
# NOTAS DE CONFIGURA√á√ÉO SNMP
# ============================================================================
#
# 1. M√âTRICAS PRINCIPAIS:
#    - up: Status de conectividade SNMP
#    - ifOperStatus/ifAdminStatus: Status das interfaces
#    - ifInOctets/ifOutOctets: Tr√°fego de rede
#    - ifInErrors/ifOutErrors: Erros de interface
#    - ifInDiscards/ifOutDiscards: Descartes de pacotes
#    - ifSpeed: Velocidade da interface
#    - sysUpTime: Tempo de funcionamento do dispositivo
#    - entPhySensorValue: Valores de sensores (temperatura, etc.)
#    - cpmCPUTotal5minRev: CPU usage (Cisco)
#    - ciscoMemoryPoolUsed/Free: Uso de mem√≥ria (Cisco)
#
# 2. FILTROS E LABELS:
#    - job=~"snmp-.*": Jobs SNMP espec√≠ficos
#    - ifAlias=~".*uplink.*|.*trunk.*": Interfaces cr√≠ticas
#    - entPhySensorType="8": Sensores de temperatura
#    - entPhySensorType="6": Sensores de status
#
# 3. THRESHOLDS RECOMENDADOS:
#    - Interface utilization: 80% warning
#    - Interface errors: 10/s warning
#    - Interface discards: 50/s warning
#    - Temperature: 60¬∞C warning, 70¬∞C critical
#    - CPU: 80% warning, 90% critical
#    - Memory: 85% warning
#    - Interface flapping: > 4 changes/10min
#
# 4. TEMPOS DE FOR:
#    - Device down: 2 minutos
#    - Interface critical: 1 minuto
#    - Performance issues: 5-15 minutos
#    - Temperature: 5-10 minutos
#    - Info alerts: 1 minuto
#
# 5. LABELS OBRIGAT√ìRIOS:
#    - severity: critical/warning/info
#    - priority: P1/P2/P3
#    - team: network (respons√°vel por rede)
#    - category: availability/performance/hardware/etc
#
# 6. CONFIGURA√á√ÉO SNMP EXPORTER:
#    - Configure m√≥dulos espec√≠ficos por tipo de dispositivo
#    - Use community strings seguros
#    - Configure timeouts adequados
#    - Implemente SNMPv3 quando poss√≠vel
#
# 7. COMANDOS DE VALIDA√á√ÉO:
#    promtool check rules snmp.yml
#    promtool query instant 'up{job=~"snmp-.*"}'
#    snmpwalk -v2c -c public <device> 1.3.6.1.2.1.2.2.1.8
# ============================================================================